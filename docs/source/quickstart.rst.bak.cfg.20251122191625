Quick Start
===========

Overview
--------

.. note::
   Different versions of Gurobi and MATLAB (and solver settings)
   can produce different feasible flux distributions that achieve
   the same objective value. As a result, inferred objective
   coefficients may differ numerically across environments, while
   qualitative trends should remain similar.
**SCOOTI: Single-Cell Optimization Objective and Tradeoff Inference** is a data-driven computational framework to identify cell-specific objectives and trade-offs from transcriptomics data.

**SCOOTI** is able to

1. Formulate metabolic objectives for various cell types, such as cancer cell lines and embryos, in different conditions.
2. Incorporate only transcriptomics data to identify metabolic objectives that is sufficient, but other omics data also works.
3. Extract information of metabolism with cell-specific objectives to analyze the difference/similarity of each cell fate.
4. Analyze the relationships among metabolites and integrate mechanistic trade-offs to identify metabolic traits.

**What is objective function in metabolic modeling?**

Biologically, metabolic objective is the metabolic goal a cell wants to achieve. Take bacterial cells for example, scientists working on metabolic modeling usually assumed that growth/doubling is the most important goal for the cells. They built a objective function called `biomass` consisted of nucleotides, amino acides, lipids and so on to represent the growth/doubling of cells which sometimes considered as the phenotypes of the cells.

Mathematically, objective function is a linear combination of several different metabolites. For example,
``Objective = 3 ATP + 2 NADPH + GSH + Ala``
where **ATP**, **NADPH**, **GSH**, and **Ala** are metabolites contributing to the metabolic objective. In other words, the phenotypes of cells or the "activities" of cells are determined by the magnitude of cells.

**We assume**

1. Every cell can optimize their functions to achieve certain metabolic goals depending on different conditions.
2. Biomass, namely cell growth/doubling, is not always the goal for different cells, especially for mammalian cells.
3. Different metabolic distributions and expression profiles can lead to the same metabolic objectives.

System Requirements
-------------------

OS Requirements
***************

The framework has been tested on the following systems:

- Linux: Centos Linux 7 (core) and Ubuntu 22.04

Python dependencies
*******************

- numpy
- scipy
- pandas
- matplotlib
- seaborn

MATLAB dependencies
*******************

- cplex (optional)
- gurobi
- cobratoolbox


Installation
************

Install via conda or pip (see README). If conda fails on Ubuntu 22.04 for ``phate``/``adjustText``, use pip:

.. code-block:: console

   (venv) $ pip install -r requirements.txt

.. note::  Cobratoolbox is required for SCOOTI to model contrained and unconstrained models. The instruction of cobratoolbox and its installation can be found `<https://opencobra.github.io/cobratoolbox/stable/installation.html>`_. In addition, optimization solvers are required for cobratoolbox. We recommend Gurobi solver for the linear version of iMAT and MOOMIN, and CPLEX 20.0.1 for COMPASS. 



Unconstrained Models with Single Objectives
-------------------------------------------
Unconstrained models optimized the demand reactions of single metabolites across different compartments. For example, ``atp[c]+atp[n]+atp[m]-->`` is one of the single objective functions. Optimizing this function is equivalent to maximizing the production of ATP. The bash script below shows the example to generate 52 unconstrained models which optimize 52 different single metabolites recorded in the csv file.


Use the provided config and runner or the convenience wrapper. Edit ``COBRA_path`` in
the config if needed for your environment.

.. code-block:: bash

   # Direct call
   bash ./scooti/run_flux.sh examples/unconstrained_demo/unconstrained_demo_config.json

   # Convenience wrapper
   bash examples/unconstrained_demo/run_unconstrained.sh

See also :doc:`unconstrained_models_demo` for detailed notes and expected outputs.


Omics-based Constrained Models
------------------------------
Constrained models are predicted metabolic fluxes with respect to transcriptomics data. Use the demo config and runner below, or see :doc:`constrained_models_demo` for details.

.. code-block:: bash

   # Direct call
   bash ./scooti/run_flux.sh examples/constrained_demo/constrained_demo_config.json

   # Convenience wrapper
   bash examples/constrained_demo/run_constrained.sh

Inference of Metabolic Objectives
---------------------------------
After preparing constrained and unconstrained models, infer metabolic objectives using the provided runner and config:

.. code-block:: bash

   # Generate demo flux predictions (MATLAB)
   bash ./scooti/run_flux.sh examples/unconstrained_demo/unconstrained_demo_config.json
   bash ./scooti/run_flux.sh examples/constrained_demo/constrained_demo_config.json

   # Run objective inference (Python)
   bash scooti/run_trainer.sh examples/run_inference/demo_inference_config.json

Metabolic Objective Analysis
----------------------------
Once we got the metabolic objectives, we can rely on a Python class `metObjAnalyzer` to perform statistical analysis, phenotype analysis, trade-off analysis, and so on. Here, we show the example to analyze the inferred metabolic objectives for proliferative and quiescent states in a python script.


.. code-block:: python

   from scooti.metObjAnalyzer import metObjAnalyzer

   # Initiate analyzer for quick checks
   moa = metObjAnalyzer(
       flux_paths={
           'Demo': './examples/constrained_demo/out/constrained_models/',
       },
       coef_paths={
           # Update this path to the CSV produced by run_trainer.sh for your expName/params
           'Demo': './examples/inference_demo/out/regression_models/flux_sl_inference_demo_cfr_True_False_recon1_DMEMF12_k[10.0_1.0_0.1]_rho[10.0_1.0_0.1].csv',
       },
       save_root_path='./result_files/',
       GEM_path='./scooti/metabolicModel/GEMs/Shen2019.mat',
       uncon_model_path='./examples/unconstrained_demo/out/unconstrained_models/',
       col_map={},
       label_func=None,
       samplingFlux_path='',
       sel_para='',
       prefix='Demo',
       medium='DMEMF12',
   )
   # Get coefficients of metabolic objectives
   moa.get_coef(metType_cluster=False)
   # Analyze coefficients with distance to biomass and statistical comparisons
   moa.coefAnalysis(
       norm=False,
       unknown_clustering=False,
       clustering=False,
       entropy=False,
       distance=True,
       compare=True,
       umap_para=[5, 50],
       recluster_min_size=10,
       method='average',
       ref_col=None,
       cutoff=0.01,
   )


Flux data format
****************

If you already have flux data and want to skip MATLAB modeling, provide a directory under ``flux_paths`` containing files as SCOOTI expects:

- For each sample: a pair of files
  - ``[prefix]..._metadata.json`` containing at least: ``input_path``, ``CFR_kappa``, ``CFR_rho``, ``medium``
  - The matching flux file named ``[prefix]..._fluxes.csv`` or ``[prefix]..._fluxes.csv.gz`` with two columns per line: ``rxn_id,value`` (header is optional)

Example demo fluxes are generated by the commands above and written under:

- Constrained fluxes: ``./examples/constrained_demo/out/constrained_models/``
- Unconstrained fluxes: ``./examples/unconstrained_demo/out/unconstrained_models/``

Outputs
*******

After completing the steps, SCOOTI writes these representative files:

- ``examples/unconstrained_demo/out/unconstrained_models/``: per-metabolite unconstrained fluxes and metadata JSONs
- ``examples/constrained_demo/out/constrained_models/``: per-sample constrained fluxes and metadata JSONs (includes ``CFR_kappa`` and ``CFR_rho``)
- ``examples/inference_demo/out/regression_models/``: coefficients CSVs (e.g., ``flux_sl_<exp>_...csv``) used by analysis
- ``examples/tradeoff_demo/out/`` or ``examples/analyze_demo/out/``: analysis figures (UMAP, entropy, correlations, Pareto plots), summaries, and helper tables

Notes
*****

- Use ``bash ./scooti/run_flux.sh ...`` for direct MATLAB runs; the ``./`` prefix is optional when using ``bash``.
- Ensure ``medium`` in configs (e.g., constrained_demo_config.json) is set to ``DMEMF12`` to match the demo medium maps.
- ``metObjAnalyzer.get_flux(kappa=..., rho=...)`` fetches reconstructed flux using the specified parameters; arguments must be numeric.
- When calling ``metObjAnalyzer`` for quick analysis, always provide a valid ``flux_paths`` mapping (even if you primarily analyze coefficients via ``coef_paths``).
